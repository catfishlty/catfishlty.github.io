<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MIT 6.824 系列"><title>MIT 6.824 分布式系统初探（一）</title>
<link rel=canonical href=https://www.catfish.top/p/mit6.824-1/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="MIT 6.824 分布式系统初探（一）">
<meta property="og:description" content="MIT 6.824 系列">
<meta property="og:url" content="https://www.catfish.top/p/mit6.824-1/">
<meta property="og:site_name" content="Catfish">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="MapReduce"><meta property="article:tag" content="GO"><meta property="article:published_time" content="2017-09-07T01:21:00+08:00"><meta property="article:modified_time" content="2021-07-15T16:36:00+08:00"><meta property="og:image" content="https://www.catfish.top/p/mit6.824-1/hadoop.png">
<meta name=twitter:title content="MIT 6.824 分布式系统初探（一）">
<meta name=twitter:description content="MIT 6.824 系列"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.catfish.top/p/mit6.824-1/hadoop.png">
<link rel="shortcut icon" href=/favicon.ico>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MPS4W3GMH8"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MPS4W3GMH8')</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://www.catfish.top class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span>
</a>
</div>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/p/mit6.824-1/>
<img src=/p/mit6.824-1/hadoop_hu7a934a9f3335148cadbaca544cf45563_202913_800x0_resize_box_3.png srcset="/p/mit6.824-1/hadoop_hu7a934a9f3335148cadbaca544cf45563_202913_800x0_resize_box_3.png 800w, /p/mit6.824-1/hadoop_hu7a934a9f3335148cadbaca544cf45563_202913_1600x0_resize_box_3.png 1600w" width=800 height=365 loading=lazy alt="Featured image of post MIT 6.824 分布式系统初探（一）">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/categories/mit6.824/>
MIT 6.824 Course
</a>
</header>
<h2 class=article-title>
<a href=/p/mit6.824-1/>MIT 6.824 分布式系统初探（一）</a>
</h2>
<h3 class=article-subtitle>
MIT 6.824 系列
</h3>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 07, 2017</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=概述>概述</h2>
<p>Google工程师Jeffrey Dean 和 Sanjay Ghemawat在2004年发表了一篇论文<a class=link href=https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf target=_blank rel=noopener>MapReduce: Simplified Data Processing on Large Clusters</a>，MapReduce作为大规模数据处理的需求下孕育而生的产物，被创造的初衷是为了解决Google公司内部搜索引擎中大规模数据的并行化处理。</p>
<p>引用<a class=link href=https://zh.wikipedia.org/wiki/MapReduce target=_blank rel=noopener>维基百科</a>中对MapReduce的介绍：</p>
<blockquote>
<p>MapReduce是Google提出的一个软件架构，用于大规模数据集（大于1TB）的并行运算。</p>
</blockquote>
<p>概念“<strong>Map（映射）</strong>”和“<strong>Reduce（归纳）</strong>”，及他们的主要思想，都是从函数式编程语言借来的，还有从矢量编程语言借来的特性。当前的软件实现是指定一个Map（映射）函数，用来把一组键值对映射成一组新的键值对，指定并发的Reduce（归纳）函数，用来保证所有映射的键值对中的每一个共享相同的键组。</p>
<p>本系列将根据<a class=link href=https://pdos.csail.mit.edu/6.824/schedule.html target=_blank rel=noopener>MIT6.824</a>课程进行学习
MapReduce</p>
<hr>
<p>简单看来，MapReduce的架构正如其名，分为Map和Reduce两部分。</p>
<p><figure style=flex-grow:139;flex-basis:334px>
<a href=/p/mit6.824-1/mapreduce_1.png data-size=631x453><img src=/p/mit6.824-1/mapreduce_1.png srcset="/p/mit6.824-1/mapreduce_1_hu5bd887eb443ed765e1e333d85ebea25c_47658_480x0_resize_box_3.png 480w, /p/mit6.824-1/mapreduce_1_hu5bd887eb443ed765e1e333d85ebea25c_47658_1024x0_resize_box_3.png 1024w" width=631 height=453 loading=lazy alt="MapReduce Overview">
</a>
<figcaption>MapReduce Overview</figcaption>
</figure></p>
<p>作为一个计算框架，其最大的核心便在于<strong>计算</strong>二字，以往处理计算的模式为单机运行，在大数据的情况下只能使用具有更强算力的计算机来完成计算工作，而算力的提升是需要花费极大的成本，这样在成本上是极为不划算的。在这一背景下MapReduce孕育而生，有个这样一个框架，就可以将数台不同算力的计算机组成一个集群，和适度的调度下并行计算提高效率降低成本。</p>
<p>根据上图，MapReduce中存在3中角色，Master，Worker（Map），Worker(Reduce）,Master负责Map，Reduce两层的调度管理,Worker(Map)负责进行Map操作，Worker（Reduce）负责进行Reduce操作</p>
<p>现在以该课程<a class=link href=https://pdos.csail.mit.edu/6.824/labs/lab-1.html target=_blank rel=noopener>lab1</a>为例来进行细致的学习，整套课程将由<a class=link href=https://golang.org/ target=_blank rel=noopener>Go</a>语言来实现。
lab1主要是对MapReduce模型进行初步的学习，实现一个本机的<code>MapReduce</code>模型，完成对多个文件的词频统计。</p>
<h3 id=示例程序流程>示例程序流程</h3>
<p>入口由上层程序控制，这个地方从master调度开始，预先定义Reduce任务个数m，再根据文本文件输入数量n。</p>
<p>master将n传递给doMap也就是Map调度层，告诉Map调度层执行n次Map计算，每个Map计算层对应输入各个文本文件的数据。</p>
<p>Map调度层将输出m*n个文件作为Map和Reduce的中间数据传递媒介，举例假设现在m为2、n为3，输出文件<code>mid-0-0</code> <code>mid-0-1</code> <code>mid-1-0</code> <code>mid-1-1</code> <code>mid-2-0</code> <code>mid-2-1</code>这六个文件,其中<code>mid-0-0</code> <code>mid-0-1</code>为第一个文本Map操作后的到的切分开的两个中间数据文件，剩下的以此类推。</p>
<p>在Reduce调度层中便会将这六个文件交由Reduce计算层处理，将件<code>mid-0-0</code> <code>mid-1-0</code> <code>mid-2-0</code>交由编号为0的Reduce计算任务处理，显然，编号为1的任务则负责剩下3个文件的规约操作。Reduce调度层中仍然会将每个Reduce计算层任务得到的数据分别存入文件，根据Reduce任务的数量m为2，则文件编号分别为<code>res-0</code> <code>res-1</code>，这样Map、Reduce两种操作完成，但整个任务还为完成。</p>
<p>Merge操作则是最后一个步骤通常由master来完成，通过merge操作将上述的<code>res-0</code> <code>res-1</code>合并，将所有结果存入到一个文件中，这样，整个MapReduce实现的多文本词频统计程序执行完毕。</p>
<hr>
<h2 id=数据结构>数据结构</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>KeyValue</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>Key</span>   <span class=kt>string</span>
	<span class=nx>Value</span> <span class=kt>string</span>
<span class=p>}</span>
</code></pre></div><h2 id=实现>实现</h2>
<h3 id=master调度>Master调度</h3>
<p><strong>master.go</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=p>(</span><span class=nx>mr</span> <span class=o>*</span><span class=nx>Master</span><span class=p>)</span> <span class=nf>run</span><span class=p>(</span><span class=nx>jobName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>files</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>nreduce</span> <span class=kt>int</span><span class=p>,</span>
	<span class=nx>schedule</span> <span class=kd>func</span><span class=p>(</span><span class=nx>phase</span> <span class=nx>jobPhase</span><span class=p>),</span>
	<span class=nx>finish</span> <span class=kd>func</span><span class=p>(),</span>
<span class=p>)</span> <span class=p>{</span>
	<span class=nx>mr</span><span class=p>.</span><span class=nx>jobName</span> <span class=p>=</span> <span class=nx>jobName</span>
	<span class=nx>mr</span><span class=p>.</span><span class=nx>files</span> <span class=p>=</span> <span class=nx>files</span>
	<span class=nx>mr</span><span class=p>.</span><span class=nx>nReduce</span> <span class=p>=</span> <span class=nx>nreduce</span>

	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s: Starting Map/Reduce task %s\n&#34;</span><span class=p>,</span> <span class=nx>mr</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=nx>mr</span><span class=p>.</span><span class=nx>jobName</span><span class=p>)</span>

	<span class=nf>schedule</span><span class=p>(</span><span class=nx>mapPhase</span><span class=p>)</span>       <span class=c1>//map层进行操作
</span><span class=c1></span>	<span class=nf>schedule</span><span class=p>(</span><span class=nx>reducePhase</span><span class=p>)</span>    <span class=c1>//reduce层进行操作
</span><span class=c1></span>	<span class=nf>finish</span><span class=p>()</span>                 <span class=c1>//结束所有worker
</span><span class=c1></span>	<span class=nx>mr</span><span class=p>.</span><span class=nf>merge</span><span class=p>()</span>               <span class=c1>//合并
</span><span class=c1></span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s: Map/Reduce task completed\n&#34;</span><span class=p>,</span> <span class=nx>mr</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span>

	<span class=nx>mr</span><span class=p>.</span><span class=nx>doneChannel</span> <span class=o>&lt;-</span> <span class=kc>true</span>
<span class=p>}</span>
</code></pre></div><p>这部分展示了master如何对map、reduce进行调度的过程，首先执行所有的map操作，执行完毕后执行所有的reduce操作进行规约，最后merge合并所有reduce之后的结果，把所有的结果汇总并存储。</p>
<hr>
<h3 id=map调度层>Map调度层</h3>
<p><strong>common_map.go</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>doMap</span><span class=p>(</span>
	<span class=nx>jobName</span> <span class=kt>string</span><span class=p>,</span> <span class=c1>// MapReduce任务名
</span><span class=c1></span>	<span class=nx>mapTaskNumber</span> <span class=kt>int</span><span class=p>,</span> <span class=c1>// Map任务序号
</span><span class=c1></span>	<span class=nx>inFile</span> <span class=kt>string</span><span class=p>,</span>
	<span class=nx>nReduce</span> <span class=kt>int</span><span class=p>,</span> <span class=c1>// Reduce Worker数量 (&#34;R&#34; in the paper)
</span><span class=c1></span>	<span class=nx>mapF</span> <span class=kd>func</span><span class=p>(</span><span class=nx>file</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>contents</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=nx>KeyValue</span><span class=p>,</span>
<span class=p>)</span> <span class=p>{</span>
	<span class=nx>dat</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>inFile</span><span class=p>)</span>                        <span class=c1>//读文本文件
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>res</span> <span class=o>:=</span> <span class=nf>mapF</span><span class=p>(</span><span class=nx>inFile</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>dat</span><span class=p>))</span>                           <span class=c1>//根据文件中的内容进行单文件Map操作
</span><span class=c1></span>	<span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>nReduce</span><span class=p>)</span>                    <span class=c1>//对于每个文本文件，将使用KeyValue的slice来存放，之后会对这部分数据进行切分，根据nReduce（reduce层worker数量）来决定划分数目
</span><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>kv</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>res</span> <span class=p>{</span>
		<span class=nx>index</span> <span class=o>:=</span> <span class=nf>ihash</span><span class=p>(</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>%</span> <span class=nx>nReduce</span>                       <span class=c1>//序号划分，根据Key做hash处理，对结果模你Reduce得到划分序号
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>m</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span> <span class=o>==</span> <span class=kc>nil</span><span class=p>{</span>
			<span class=nx>m</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>m</span><span class=p>[</span><span class=nx>index</span><span class=p>][</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>Value</span>
	<span class=p>}</span>                                                          
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>nReduce</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>filename</span> <span class=o>:=</span> <span class=nf>reduceName</span><span class=p>(</span><span class=nx>jobName</span><span class=p>,</span> <span class=nx>mapTaskNumber</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
		<span class=nx>jsonObj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>                      <span class=c1>//使用json作为中间数据
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=nx>jsonObj</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>               <span class=c1>//将数据写入到文件中 //将json数据写入到文件中，供Reduce操作使用
</span><span class=c1></span>	<span class=p>}</span>
</code></pre></div><p>Map调度层提供数据的输入与输出，不关心计算过程</p>
<hr>
<h3 id=map计算层>Map计算层</h3>
<p><strong>wc.go</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//filename 为输入文件文件名
</span><span class=c1>//contents 为文本内容
</span><span class=c1></span><span class=kd>func</span> <span class=nf>mapF</span><span class=p>(</span><span class=nx>filename</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>contents</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=nx>mapreduce</span><span class=p>.</span><span class=nx>KeyValue</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>res</span> <span class=p>[]</span><span class=nx>mapreduce</span><span class=p>.</span><span class=nx>KeyValue</span>
	<span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span> <span class=kt>int</span><span class=p>)</span>
	<span class=nx>reg</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=s>&#34;\n|\r|\t|[ ]+|[\\-]+|\\(|\\)&#34;</span><span class=p>)</span>
	<span class=nx>contents</span> <span class=p>=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>ReplaceAllString</span><span class=p>(</span><span class=nx>contents</span><span class=p>,</span><span class=s>&#34; &#34;</span><span class=p>)</span>
	<span class=nx>reg</span> <span class=p>=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=s>&#34;[^(a-zA-Z )]&#34;</span><span class=p>)</span>
	<span class=nx>contents</span> <span class=p>=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>ReplaceAllString</span><span class=p>(</span><span class=nx>contents</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>)</span>
	<span class=c1>//fmt.Println(contents)
</span><span class=c1></span>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>contents</span><span class=p>,</span><span class=s>&#34; &#34;</span><span class=p>)</span>

	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span><span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span><span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>str</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>TrimSpace</span><span class=p>(</span><span class=nx>s</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
		<span class=nx>m</span><span class=p>[</span><span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>str</span><span class=p>)]</span><span class=o>++</span>
	<span class=p>}</span>
	<span class=k>for</span> <span class=nx>k</span><span class=p>,</span><span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span><span class=p>{</span>
		<span class=nx>val</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
		<span class=nx>res</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>mapreduce</span><span class=p>.</span><span class=nx>KeyValue</span><span class=p>{</span><span class=nx>k</span><span class=p>,</span> <span class=nx>val</span> <span class=p>})</span>
	<span class=p>}</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>res</span>
<span class=p>}</span>
</code></pre></div><p>Map计算层根据输入的文本内容完成下列步骤：</p>
<ol>
<li>使用正则表达式将<code>\n</code> <code>\t</code> <code>\r</code>替换为空格</li>
<li>使用正则表达式将无关字符删除</li>
<li>使用<code>strings.Split</code>方法根据空格进行划分</li>
<li>取出划分后的每个词，使用<code>strings.TrimSpace</code>方法去除两端空格，使用<code>map[string] int</code>结构的m来完成统计</li>
<li>将<code>map[string] int</code>转换为<code>[]KeyValue</code>返回</li>
</ol>
<p><em><strong>Map计算层和Map调度层共同组成的Map的结构，一个负责计算，一个负责IO，分工明确</strong></em></p>
<hr>
<h3 id=reduce调度层>Reduce调度层</h3>
<p><strong>common_reduce.go</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>doReduce</span><span class=p>(</span>
	<span class=nx>jobName</span> <span class=kt>string</span><span class=p>,</span> <span class=c1>// MapReduce任务名
</span><span class=c1></span>	<span class=nx>reduceTaskNumber</span> <span class=kt>int</span><span class=p>,</span> <span class=c1>// Reduce任务序号
</span><span class=c1></span>	<span class=nx>outFile</span> <span class=kt>string</span><span class=p>,</span> <span class=c1>// 输出文件路径
</span><span class=c1></span>	<span class=nx>nMap</span> <span class=kt>int</span><span class=p>,</span> <span class=c1>// Map任务数 (&#34;M&#34; in the paper)
</span><span class=c1></span>	<span class=nx>reduceF</span> <span class=kd>func</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>values</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>string</span><span class=p>,</span>
<span class=p>)</span> <span class=p>{</span>
	<span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>string</span><span class=p>)</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>nMap</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>filename</span> <span class=o>:=</span> <span class=nf>reduceName</span><span class=p>(</span><span class=nx>jobName</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>reduceTaskNumber</span><span class=p>)</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
		<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=kd>var</span> <span class=nx>tm</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
		<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>tm</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tm</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
				<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
			<span class=p>}</span>
			<span class=nx>m</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=nx>k</span><span class=p>],</span> <span class=nx>v</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=nx>dataM</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>KeyValue</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span>
	<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span> <span class=p>{</span>
		<span class=nx>ans</span> <span class=o>:=</span> <span class=nf>reduceF</span><span class=p>(</span><span class=nx>k</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
		<span class=nx>dataM</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>dataM</span><span class=p>,</span> <span class=nx>KeyValue</span><span class=p>{</span><span class=nx>k</span><span class=p>,</span><span class=nx>ans</span><span class=p>})</span>
	<span class=p>}</span>
	<span class=nx>jsonData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>dataM</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>outFile</span><span class=p>,</span> <span class=nx>jsonData</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Reduce调度层完成的工作是将Map执行后的文件读入为数据交有Reduce来规约，同样也不负责Reduce具体的过程，仅负责数据的读入（文件读入）和数据的保存（文件写出）</p>
<hr>
<h3 id=reduce计算层>Reduce计算层</h3>
<p><strong>wc.go</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//key为文本中的单词
</span><span class=c1>//values为各个Map处理后得到的单词的个数
</span><span class=c1></span><span class=kd>func</span> <span class=nf>reduceF</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>values</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=nx>sum</span> <span class=o>:=</span><span class=mi>0</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span><span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>values</span><span class=p>{</span>
		<span class=nx>num</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=c1>//string转int
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>sum</span><span class=o>+=</span><span class=nx>num</span>                   <span class=c1>//累加
</span><span class=c1></span>	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>sum</span><span class=p>)</span>       <span class=c1>//将int转string返回
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>Reduce计算层则仅仅负责数据的规约，步骤如下：</p>
<ol>
<li>遍历整个values切片</li>
<li>将values的数值累加</li>
<li>将累加总和作为结果返回</li>
</ol>
<hr>
<h3 id=merge>Merge</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>mr</span> <span class=o>*</span><span class=nx>Master</span><span class=p>)</span> <span class=nf>merge</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>kvs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span>           <span class=c1>//总的数据存放
</span><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>mr</span><span class=p>.</span><span class=nx>nReduce</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>p</span> <span class=o>:=</span> <span class=nf>mergeName</span><span class=p>(</span><span class=nx>mr</span><span class=p>.</span><span class=nx>jobName</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>        <span class=c1>//merge文件名生成
</span><span class=c1></span>		<span class=nx>file</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span><span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Merge: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=kd>var</span> <span class=nx>jsonObj</span> <span class=p>[]</span><span class=nx>KeyValue</span>               
		<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>file</span><span class=p>,</span><span class=o>&amp;</span><span class=nx>jsonObj</span><span class=p>)</span>  <span class=c1>//json解码
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Merge: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span><span class=nx>v</span><span class=o>:=</span><span class=k>range</span> <span class=nx>jsonObj</span><span class=p>{</span>
			<span class=nx>kvs</span><span class=p>[</span><span class=nx>v</span><span class=p>.</span><span class=nx>Key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v</span><span class=p>.</span><span class=nx>Value</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Merge操作便将Reduce操作得到的数据进行合并，完成最后一步工作。</p>
<hr>
<h2 id=总结>总结</h2>
<p>通过这几天短暂的学习，MapReduce模型确实能够极大的利用现有计算资源来打造一个算力强劲的计算机集群，但是本实例中也存在几个局限性：</p>
<ol>
<li>本实例仅在单机中运行</li>
<li>操作间数据交换使用文件，在性能上可能会有一定影响</li>
<li>任务划分的科学性也应该是性能上应该考虑的问题，集群中计算机算力各不相同的时候，能者多劳，任务的划分应更加合理，才可能避免水桶原理造成的性能上的损失</li>
</ol>
<p>如有不足之处，恳请提出批评！</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/mapreduce/>MapReduce</a>
<a href=/tags/go/>GO</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<section class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span class=article-time--modified>
最后更新于 Jul 15, 2021 16:36 +0800
</span>
</section></footer>
</article>
<aside class=related-contents--wrapper>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2016 -
2021 Catfish
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#概述>概述</a>
<ol>
<li><a href=#示例程序流程>示例程序流程</a></li>
</ol>
</li>
<li><a href=#数据结构>数据结构</a></li>
<li><a href=#实现>实现</a>
<ol>
<li><a href=#master调度>Master调度</a></li>
<li><a href=#map调度层>Map调度层</a></li>
<li><a href=#map计算层>Map计算层</a></li>
<li><a href=#reduce调度层>Reduce调度层</a></li>
<li><a href=#reduce计算层>Reduce计算层</a></li>
<li><a href=#merge>Merge</a></li>
</ol>
</li>
<li><a href=#总结>总结</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>